--!strict
-- Ligaya Definition File Parser
-- Parses .ligaya files and generates type-safe Lua code

local LigayaParser = {}

-- Type mapping from .ligaya to Luau
local TYPE_MAP = {
	number = "number",
	string = "string",
	boolean = "boolean",
	Vector3 = "Vector3",
	Vector2 = "Vector2",
	CFrame = "CFrame",
	Color3 = "Color3",
	Instance = "Instance",
	table = "table",
	["()"] = "nil", -- Empty data
}

-- Parse a single line
local function parseLine(line: string): string?
	-- Remove comments
	line = line:match("^(.-)%-%-") or line
	line = line:match("^%s*(.-)%s*$") -- Trim whitespace

	if line == "" then
		return nil
	end

	return line
end

-- Parse event definition
local function parseEvent(lines: { string }, startIndex: number): (any?, number)
	local event = {
		Name = "",
		From = "Server",
		Type = "Reliable",
		Priority = "Normal",
		Compress = false,
		DataTypes = {},
	}

	-- Parse event name
	local eventLine = lines[startIndex]
	local eventName = eventLine:match("event%s+(%w+)%s*{")
	if not eventName then
		error(`Invalid event definition at line {startIndex}: {eventLine}`)
	end

	event.Name = eventName

	-- Parse event properties
	local i = startIndex + 1
	while i <= #lines do
		local line = parseLine(lines[i])

		if not line then
			i += 1
			continue
		end

		-- End of event
		if line:match("^}") then
			return event, i
		end

		-- Parse property
		local key, value = line:match("(%w+):%s*(.+),?")
		if key and value then
			value = value:gsub(",$", "") -- Remove trailing comma

			if key == "from" then
				event.From = value
			elseif key == "type" then
				event.Type = value
			elseif key == "priority" then
				event.Priority = value
			elseif key == "compress" then
				event.Compress = value == "true"
			elseif key == "data" then
				-- Parse data types
				local dataStr = value:match("%((.*)%)")
				if dataStr and dataStr ~= "" then
					for dataType in dataStr:gmatch("[^,]+") do
						dataType = dataType:match("^%s*(.-)%s*$") -- Trim
						table.insert(event.DataTypes, dataType)
					end
				end
			end
		end

		i += 1
	end

	error(`Unclosed event definition: {eventName}`)
end

-- Parse .ligaya file
function LigayaParser.Parse(content: string): { any }
	local lines = {}
	for line in content:gmatch("[^\r\n]+") do
		table.insert(lines, line)
	end

	local events = {}
	local i = 1

	while i <= #lines do
		local line = parseLine(lines[i])

		if line and line:match("^event%s+") then
			local event, endIndex = parseEvent(lines, i)
			table.insert(events, event)
			i = endIndex
		end

		i += 1
	end

	return events
end

-- Generate Luau type string from data types
local function generateTypeString(dataTypes: { string }): string
	if #dataTypes == 0 then
		return ""
	end

	local types = {}
	for _, dataType in dataTypes do
		local luauType = TYPE_MAP[dataType] or "any"
		table.insert(types, luauType)
	end

	return table.concat(types, ", ")
end

-- Generate parameter list
local function generateParamList(dataTypes: { string }): string
	if #dataTypes == 0 then
		return ""
	end

	local params = {}
	for i, dataType in dataTypes do
		table.insert(params, `param{i}: {TYPE_MAP[dataType] or "any"}`)
	end

	return table.concat(params, ", ")
end

-- Generate type-safe Lua code
function LigayaParser.GenerateCode(events: { any }, moduleName: string): string
	local code = {
		"--!strict",
		"-- Auto-generated by Ligaya Code Generator",
		"-- DO NOT EDIT THIS FILE MANUALLY",
		"",
		'local ReplicatedStorage = game:GetService("ReplicatedStorage")',
		"local Ligaya = require(ReplicatedStorage.Ligaya)",
		"",
		`local {moduleName} = \{\}`,
		"",
		"-- Initialize Ligaya",
		"Ligaya:Initialize()",
		"",
		"-- Register events",
	}

	-- Register all events
	for _, event in events do
		table.insert(code, `Ligaya:RegisterEvent(\{`)
		table.insert(code, `\tName = "{event.Name}",`)
		table.insert(code, `\tFrom = "{event.From}",`)
		table.insert(code, `\tType = "{event.Type}",`)
		table.insert(code, `\tPriority = "{event.Priority}",`)
		if event.Compress then
			table.insert(code, `\tCompress = true,`)
		end
		table.insert(code, `\})`)
		table.insert(code, "")
	end

	-- Generate type-safe wrappers
	table.insert(code, "-- Type-safe event wrappers")
	table.insert(code, "")

	for _, event in events do
		local typeStr = generateTypeString(event.DataTypes)
		local paramList = generateParamList(event.DataTypes)

		-- Generate Fire methods based on direction
		if event.From == "Client" then
			-- Client events
			table.insert(code, `-- {event.Name}: Client -> Server`)
			table.insert(code, `function {moduleName}.{event.Name}Fire({paramList})`)
			if #event.DataTypes > 0 then
				local params = {}
				for i = 1, #event.DataTypes do
					table.insert(params, `param{i}`)
				end
				table.insert(code, `\tLigaya:Fire("{event.Name}", {table.concat(params, ", ")})`)
			else
				table.insert(code, `\tLigaya:Fire("{event.Name}")`)
			end
			table.insert(code, "end")
			table.insert(code, "")

			-- Server-side listener
			table.insert(
				code,
				`function {moduleName}.{event.Name}On(handler: (player: Player{#event.DataTypes > 0 and ", " or ""}{typeStr}) -> ())`
			)
			table.insert(code, `\treturn Ligaya:On("{event.Name}", handler)`)
			table.insert(code, "end")
			table.insert(code, "")
		else
			-- Server events
			table.insert(code, `-- {event.Name}: Server -> Client`)
			table.insert(
				code,
				`function {moduleName}.{event.Name}Fire(player: Player{#event.DataTypes > 0 and ", " or ""}{paramList})`
			)
			if #event.DataTypes > 0 then
				local params = {}
				for i = 1, #event.DataTypes do
					table.insert(params, `param{i}`)
				end
				table.insert(code, `\tLigaya:Fire(player, "{event.Name}", {table.concat(params, ", ")})`)
			else
				table.insert(code, `\tLigaya:Fire(player, "{event.Name}")`)
			end
			table.insert(code, "end")
			table.insert(code, "")

			table.insert(code, `function {moduleName}.{event.Name}FireAll({paramList})`)
			if #event.DataTypes > 0 then
				local params = {}
				for i = 1, #event.DataTypes do
					table.insert(params, `param{i}`)
				end
				table.insert(code, `\tLigaya:FireAll("{event.Name}", {table.concat(params, ", ")})`)
			else
				table.insert(code, `\tLigaya:FireAll("{event.Name}")`)
			end
			table.insert(code, "end")
			table.insert(code, "")

			table.insert(
				code,
				`function {moduleName}.{event.Name}FireList(players: \{Player\}{#event.DataTypes > 0 and ", " or ""}{paramList})`
			)
			if #event.DataTypes > 0 then
				local params = {}
				for i = 1, #event.DataTypes do
					table.insert(params, `param{i}`)
				end
				table.insert(code, `\tLigaya:FireList(players, "{event.Name}", {table.concat(params, ", ")})`)
			else
				table.insert(code, `\tLigaya:FireList(players, "{event.Name}")`)
			end
			table.insert(code, "end")
			table.insert(code, "")

			table.insert(
				code,
				`function {moduleName}.{event.Name}FireExcept(excludePlayer: Player{#event.DataTypes > 0 and ", " or ""}{paramList})`
			)
			if #event.DataTypes > 0 then
				local params = {}
				for i = 1, #event.DataTypes do
					table.insert(params, `param{i}`)
				end
				table.insert(code, `\tLigaya:FireExcept(excludePlayer, "{event.Name}", {table.concat(params, ", ")})`)
			else
				table.insert(code, `\tLigaya:FireExcept(excludePlayer, "{event.Name}")`)
			end
			table.insert(code, "end")
			table.insert(code, "")

			-- Client-side listener
			table.insert(code, `function {moduleName}.{event.Name}On(handler: ({typeStr}) -> ())`)
			table.insert(code, `\treturn Ligaya:On("{event.Name}", handler)`)
			table.insert(code, "end")
			table.insert(code, "")
		end
	end

	table.insert(code, `return {moduleName}`)

	return table.concat(code, "\n")
end

return LigayaParser
